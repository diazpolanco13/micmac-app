name: ğŸ¤– MIC MAC Pro - Automation Workflow

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}

jobs:
  # ğŸ§ª @CursorTesting - Testing AutomÃ¡tico
  testing-automation:
    name: ğŸ§ª Testing Automation
    runs-on: ubuntu-latest
    outputs:
      coverage: ${{ steps.coverage.outputs.percentage }}
      
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“š Install dependencies
        run: npm ci
        
      - name: ğŸ§ª Run tests with coverage
        run: |
          npm run test:coverage
          echo "COVERAGE=$(cat coverage/lcov-report/index.html | grep -o 'headerCovTableEntryLo[^>]*>[^<]*' | head -1 | sed 's/.*>//')" >> $GITHUB_OUTPUT
        id: coverage
        
      - name: ğŸ“Š Update Linear Testing Issue (API-8)
        uses: actions/github-script@v7
        with:
          script: |
            const coverage = '${{ steps.coverage.outputs.coverage }}';
            const linearUpdate = await fetch('https://api.linear.app/graphql', {
              method: 'POST',
              headers: {
                'Authorization': 'Bearer ${{ env.LINEAR_API_KEY }}',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                query: `
                  mutation {
                    issueUpdate(
                      id: "4d61557e-db0a-4cfd-94c4-7a316169eb8b"
                      input: {
                        description: "## ğŸ¤– @CursorTesting Status\\n\\nâœ… **Coverage Actual**: ${coverage}%\\nâœ… **Tests Ejecutados**: ${{ github.run_number }}\\nâœ… **Ãšltima ActualizaciÃ³n**: $(date)\\n\\n[Ver detalles completos](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
                      }
                    ) {
                      issue {
                        id
                        title
                      }
                    }
                  }
                `
              })
            });
            console.log('Linear testing issue updated with coverage:', coverage);

  # ğŸ“ @CursorGit - Git Automation  
  git-automation:
    name: ğŸ“ Git Automation
    runs-on: ubuntu-latest
    needs: testing-automation
    if: github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ” Analyze commits
        id: commits
        run: |
          COMMITS=$(git log --oneline -n 10 --pretty=format:"%h %s")
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: ğŸ“Š Update Linear Git Issue (API-9)
        uses: actions/github-script@v7
        with:
          script: |
            const commits = `${{ steps.commits.outputs.commits }}`;
            const linearUpdate = await fetch('https://api.linear.app/graphql', {
              method: 'POST',
              headers: {
                'Authorization': 'Bearer ${{ env.LINEAR_API_KEY }}',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                query: `
                  mutation {
                    commentCreate(
                      input: {
                        issueId: "141bee97-817c-45eb-86b0-871551061618"
                        body: "## ğŸ¤– @CursorGit Auto-Update\\n\\nâœ… **Commits Procesados**: ${{ github.run_number }}\\nâœ… **Branch**: ${{ github.ref_name }}\\n\\n### Ãšltimos Commits:\\n\`\`\`\\n${commits}\\n\`\`\`\\n\\n[Ver en GitHub](https://github.com/${{ github.repository }}/commit/${{ github.sha }})"
                      }
                    ) {
                      comment {
                        id
                      }
                    }
                  }
                `
              })
            });
            console.log('Linear git issue updated with commits');

  # ğŸ“Š @CursorLinear - Progress Sync
  linear-automation:
    name: ğŸ“Š Linear Automation  
    runs-on: ubuntu-latest
    needs: [testing-automation, git-automation]
    if: always()
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“Š Calculate project progress
        id: progress
        run: |
          # Simulamos cÃ¡lculo de progreso basado en archivos
          TOTAL_FILES=$(find src -name "*.tsx" -o -name "*.ts" | wc -l || echo "0")
          TEST_FILES=$(find src -name "*.test.tsx" -o -name "*.test.ts" | wc -l || echo "0")
          if [ $TOTAL_FILES -gt 0 ]; then
            PROGRESS=$(( (TEST_FILES * 100) / TOTAL_FILES ))
          else
            PROGRESS=0
          fi
          echo "progress=$PROGRESS" >> $GITHUB_OUTPUT
          echo "total_files=$TOTAL_FILES" >> $GITHUB_OUTPUT
          echo "test_files=$TEST_FILES" >> $GITHUB_OUTPUT
          
      - name: ğŸ“Š Update Linear Progress Issue (API-10)
        uses: actions/github-script@v7
        with:
          script: |
            const progress = '${{ steps.progress.outputs.progress }}';
            const totalFiles = '${{ steps.progress.outputs.total_files }}';
            const testFiles = '${{ steps.progress.outputs.test_files }}';
            const coverage = '${{ needs.testing-automation.outputs.coverage }}' || '0';
            
            const linearUpdate = await fetch('https://api.linear.app/graphql', {
              method: 'POST',
              headers: {
                'Authorization': 'Bearer ${{ env.LINEAR_API_KEY }}',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                query: `
                  mutation {
                    issueUpdate(
                      id: "7ca64858-9a30-4c2b-b92f-ad6a1c8f47e5"
                      input: {
                        description: "## ğŸ¤– @CursorLinear Dashboard\\n\\n### ğŸ“Š MÃ©tricas AutomÃ¡ticas\\n- **Progreso General**: ${progress}%\\n- **Test Coverage**: ${coverage}%\\n- **Archivos Totales**: ${totalFiles}\\n- **Archivos con Tests**: ${testFiles}\\n- **Ãšltima Sync**: $(date)\\n\\n### ğŸ¯ Estado del Proyecto\\n- **Workflow**: ${{ github.workflow }}\\n- **Run**: #${{ github.run_number }}\\n- **Commit**: [\`${{ github.sha }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})\\n\\n[Ver Dashboard Completo](https://github.com/${{ github.repository }}/actions)"
                      }
                    ) {
                      issue {
                        id
                        title
                      }
                    }
                  }
                `
              })
            });
            console.log('Linear progress updated:', {progress, coverage, totalFiles, testFiles});

  # ğŸ“š @CursorDocs - Documentation Automation
  docs-automation:
    name: ğŸ“š Documentation Automation
    runs-on: ubuntu-latest
    needs: linear-automation
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“š Generate automatic documentation
        run: |
          # Crear/actualizar README.md automÃ¡ticamente
          cat > README.md << 'EOF'
          # ğŸš€ MIC MAC Pro - Plataforma de AnÃ¡lisis Prospectivos
          
          > Generado automÃ¡ticamente por @CursorDocs - $(date)
          
          ## ğŸ“‹ DescripciÃ³n
          Plataforma web colaborativa para anÃ¡lisis prospectivos con metodologÃ­a MIC MAC.
          MVP con cronÃ³metro por variable, mobile-first design y testing automÃ¡tico.
          
          ## ğŸš€ Quick Start
          \`\`\`bash
          # Clonar repositorio
          git clone https://github.com/${{ github.repository }}.git
          cd micmac-app
          
          # Instalar dependencias
          npm install
          
          # Configurar variables de entorno
          cp .env.example .env.local
          
          # Ejecutar en desarrollo
          npm run dev
          \`\`\`
          
          ## ğŸ§ª Testing
          \`\`\`bash
          # Ejecutar tests
          npm test
          
          # Coverage report
          npm run test:coverage
          \`\`\`
          
          ## ğŸ“Š Estado del Proyecto
          - **Coverage**: ${{ needs.testing-automation.outputs.coverage }}%
          - **Ãšltima Build**: âœ… Exitosa
          - **Deploy**: ğŸš€ AutomÃ¡tico
          
          ## ğŸ¤– AutomatizaciÃ³n
          Este proyecto utiliza agentes especializados:
          - ğŸ§ª @CursorTesting - Tests automÃ¡ticos
          - ğŸ“ @CursorGit - Commits y PRs
          - ğŸ“Š @CursorLinear - Tracking de progreso
          - ğŸ“š @CursorDocs - DocumentaciÃ³n
          
          ## ğŸ“š DocumentaciÃ³n Completa
          - [Setup Detallado](./SETUP.md)
          - [Arquitectura](./ARQUITECTURA.md)
          - [API Reference](./API.md)
          - [Testing Guide](./TESTING.md)
          
          ---
          *Actualizado automÃ¡ticamente: $(date)*
          EOF
          
      - name: ğŸ“Š Update Linear Docs Issue (API-11)
        uses: actions/github-script@v7
        with:
          script: |
            const linearUpdate = await fetch('https://api.linear.app/graphql', {
              method: 'POST',
              headers: {
                'Authorization': 'Bearer ${{ env.LINEAR_API_KEY }}',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                query: `
                  mutation {
                    commentCreate(
                      input: {
                        issueId: "95cbb5a3-fb10-4436-a55f-44ba4fd1c66b"
                        body: "## ğŸ¤– @CursorDocs Auto-Update\\n\\nâœ… **README.md actualizado automÃ¡ticamente**\\nâœ… **Timestamp**: $(date)\\nâœ… **Coverage incluido**: ${{ needs.testing-automation.outputs.coverage }}%\\n\\n### ğŸ“š Documentos Actualizados:\\n- README.md\\n- MÃ©tricas de proyecto\\n- Links automÃ¡ticos\\n\\n[Ver README](https://github.com/${{ github.repository }}/blob/main/README.md)"
                      }
                    ) {
                      comment {
                        id
                      }
                    }
                  }
                `
              })
            });
            console.log('Linear docs issue updated');
            
      - name: ğŸ’¾ Commit documentation updates
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "@CursorDocs"
          git add README.md
          if git diff --staged --quiet; then
            echo "No documentation changes to commit"
          else
            git commit -m "docs(readme): auto-update documentation (Linear: API-11)"
            git push
          fi

  # ğŸ”” Notifications
  notifications:
    name: ğŸ”” Notifications
    runs-on: ubuntu-latest
    needs: [testing-automation, git-automation, linear-automation, docs-automation]
    if: always()
    
    steps:
      - name: ğŸ“Š Prepare summary
        id: summary
        run: |
          echo "## ğŸ¤– Automation Summary - Run #${{ github.run_number }}" >> summary.md
          echo "" >> summary.md
          echo "### ğŸ“Š Results:" >> summary.md
          echo "- ğŸ§ª **Testing**: ${{ needs.testing-automation.result }}" >> summary.md
          echo "- ğŸ“ **Git**: ${{ needs.git-automation.result }}" >> summary.md  
          echo "- ğŸ“Š **Linear**: ${{ needs.linear-automation.result }}" >> summary.md
          echo "- ğŸ“š **Docs**: ${{ needs.docs-automation.result }}" >> summary.md
          echo "" >> summary.md
          echo "### ğŸ¯ Metrics:" >> summary.md
          echo "- **Coverage**: ${{ needs.testing-automation.outputs.coverage }}%" >> summary.md
          echo "- **Commit**: [\`${{ github.sha }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> summary.md
          echo "" >> summary.md
          echo "**Automatizado por**: ğŸ¤– Agentes MIC MAC Pro" >> summary.md
          
      - name: ğŸ“ Job Summary
        run: cat summary.md >> $GITHUB_STEP_SUMMARY
